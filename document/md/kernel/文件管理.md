## 文件管理

| 作者                 | 时间       | QQ技术交流群                      |
| -------------------- | ---------- | --------------------------------- |
| perrynzhou@gmail.com | 2020/03/03 | 中国开源存储技术交流群(672152841) |




- 文件系统负责对文件存储器的存储空间进行组织、分配、存储文件、并对存入的文件进行保护、检索。文件系统为用户提供如下功能
  - 文件存储空间管理，分配和回收存储空间，提供存储空间的利用率
  - 实现文件名到物理地址的映射。
  - 实施对文件的操作，包括建立。删除、读写和目录操作
  - 实现文件的共享和提供文件的保护功能
  - 提供文件能操作的接口

- 文件的存储方式
  - 连续存储，把文件分为与物理块存储大小相等的逻辑块，并未这个文件分配一组相邻的物理块，并把逻辑文件中的内容顺序的存储到相邻的各个物理块中，连续存储有利于顺序访问，一旦知道文件起始物理块地址吗和文件长度就可以直接访问，但是连续存储形式会导致文件在删除时空间回收产生大量碎片，同时采用顺序存储需要知道文件的长度
  - 链式存储，为每个物理块上链接指针，将属于同一个文件的物理块链接为一个链表，链式存储唯一的缺陷不支持高效的直接存储，并且文件分配表也需要占用较大的空间
  - 索引存储，每个文件分配一个索引块，把分配给该文件的所有物理块都记录在该索引块中，该索引块就成为一个含有多个物理块号的数组。

- 磁盘管理
  - 每个扇区包括标识字段和数据，其中标识字段是有磁道号、磁头号、扇区号三部分组成。
  - 磁盘类型有固定磁头类型和移动磁头类型，固定磁头类型中每个磁道都会有一个读写磁头；移动磁头类型每个盘面只有一个磁头。
  - 磁盘访问时间=寻道时间+旋转延迟时间+数据传输时间。寻道时间是指把磁头移动到指定的磁道上所需要的时间；旋转延迟时间，是指扇区移动到磁头下面所经历的时间；数据传输时间，是指数据从磁盘读出或者写入数据所经历的时间。
  - 磁盘调度算法包括公平调度算法(FCFS)、最短寻道时间有限算法(SSTF)、扫描算法(SCAN)、循环扫描算法(CCSAN)。
    - 公平调度算法，每个请求按照先来后到的顺序进行处理，这个算法没有对寻道时间进行优化，导致平均寻道时间过长
    - 最短寻道时间优化算法，该算法选择使磁头臂从当前位置开始处理移动最少的的磁盘IO请求，这个算法总是选择处理导致最小寻道时间的请求，这个会发会导致某个进程发生饥饿现象
    - 扫描算法，这个算法要求磁头臂仅仅沿着一个方向移动，并且途中满足所有未完成的请求，直到它到达这方向上的最后一个磁道或者在这个方向上没有别的请求为止；然后倒转服务方向，沿着相反的方向进行扫描，同样按照顺序完成所有的请求，这个算法也被称为电梯算法
    - 循环扫描算法，该算法只能朝着一个方向移动移动，磁头到头掉头后不立即扫描，而是立即回到起点再重新扫描，在磁头到起点之前不处理任何请求。
    - 扫描算法和循环扫描算法更适合磁盘负担中磁盘

- 文件管理
  - linux中文件是由目录项标识,目录项是有文件名和属性、位置、大小、建立和修改时间、访问权限等文件控制信息组成。文件控制信息单独组成一个inode结构体，每个inode是目录项进行管理。linux目录项是有文件名和、inode组成。
  ![目录项](../images/dentry.jpg)
  - linux文件类型普通文件、目录文件、设备文件、管道文件、链接文件。
  - 虚拟文件系统(vfs)，把各种不同的纹理文件系统的所有特性进行抽象，建立一个面向各种物理文件系统的转换机制，通过这个转换机制，把各种不同的物理文件系统转换为一个具有统一共性（读写接口)的虚拟文件系统，这个就是虚拟文件系统所做的事情。vfs仅仅存在于内存，具体的文件系统比如xfs/ext4等存在于外存空间中。
  ![虚拟文件系统架构](../images/vfs-arc.jpg)