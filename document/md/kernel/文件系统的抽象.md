# 文件系统的抽象

| author | update |
| ------ | ------ |
| perrynzhou@gmail.com | 2020/05/24 |

## 如何理解文件系统？
  - 第一个方面要文件系统使用了哪些数据结构，具体点就是文件系统如何使用数据结构来组织数据和元数据
  - 另外一个方面就是访问方式，比如进程打开一个文件将会发生什么等
  - 文件系统是是如何整体组织，文件系统第一步需要做的就是将磁盘分块，将磁盘分为连续的块，每个块大小为4K。任何文件系统中的大多数空间都是用户数据，我们将存储用户数据的空间叫做数据区域。同时文件系统需要记录每个文件的信息，该信息是元数据的关键部分，元数记录一个文件包括哪些数据块、文件大小、文件所有者、文件访问权限、文件修改时间等信息。为了表示这些元数据，文件系统会用inode数据结构表示
  - 为了存放inode,文件系统实现过程中，需要在磁盘上留出一部分空间来存储inode信息，这部分存储inode的空间叫做inode table,它仅仅你保存了一个inode数组
  - 文件系统采用位图来记录相应的对象或者块是否正在被使用。
  - 在磁盘文件系统中还有最后的一块，就是超级块(super block).超级块记录特定文件系统的信息，例如文件系统类型、文件系统包括多少inode、文件系统包括多少数据块、inode表的开始文件等信息

## 文件系统的五层抽象
  - 从扇区到磁盘块的抽象
  - 从单个磁盘块到多个进程的磁盘请求队列
  - 从磁盘请求到高速缓存
  - 从磁盘块集合到文件的抽象
  - 从多个文件到构建文件系统

## 磁盘的工作原理
  - 从CPU开始，当用户想要使用磁盘时候，由CPU发送命令给磁盘设备，最终通过 "out ax,端口号"指令告诉磁盘具体的操作细节
  - 从磁盘开始，磁盘在完成操作后用磁盘中断告诉CPU，CPU收到此中断后会接着完成后续操作，比如把磁盘读取到的数据复制到用户态的buf中

## 扇区到磁盘块的抽象
- 磁盘的读写过程会经历三个步骤，它们分别是：移动磁臂(这个也叫寻道)，旋转磁盘，数据读取。磁盘读写时间当然也是由这三个操作的时间决定，移动磁臂同查个嗯需要10ms,即寻道时间为10ms;磁盘转速为7200转，它旋转的半圈平均时间为4ms,即旋转时间为4ms;现在磁盘传输的速度在每秒几十兆字节以上。读写磁盘的主要时间花费在磁盘的寻道上。
- 多个连续的扇区就是一个磁盘块，采用磁盘块后，经过一次磁盘块寻道时间和磁盘旋转以后可以读写更大一块磁盘的空间，这样读写磁盘的效率就会提高很多。

## 多进程的磁盘请求
- 经过扇区到磁盘块抽象，操作系统要处理磁盘读写的第一步是，从磁盘请求队列中取出一个请求
- 然后取出磁盘请求中的读写的磁盘号
- 根据磁盘号计算出柱面（C），磁头（H），扇区（S）
- 用out语句向磁盘控制器发出具体指令，这里涉及到如何选择一个合适的请求来配分资源，这个就需要一个经典的调度算法，影响磁盘读写的时间的主要因素是寻道（寻找柱面），所以磁盘的调度算法也是解决如何高效的寻找柱面
  - 磁盘调度的最短寻道时间优先（SSTF）算法，每次选择离当前磁头最近的柱面的请求进行处理
  - 磁盘调度的扫描算法（SCAN），首先向一个方向进行扫描，处理经过的所有请求，直到这个方向上不再有磁盘请求时，磁头开始向另外一个方向扫描，并处理经过的所有磁盘请求
  - 磁盘调度的循环扫描算法（CSCAN，电梯调度算法），采用复位扫描，首先向某个方向进行扫描，比如沿着柱面小的方向扫描，处理经过的所有磁盘请求，直到这个方向不再磁盘请求时，磁头迅速复位到另外一个方向的最大请求位置，然后在沿着同样的方向进行扫描，处理经过的所有磁盘请求

## 磁盘高速缓存
- 磁盘高速缓存是磁盘管理的又一层抽象，即操作系统将磁盘数据变成一系列位于内核态内存中的缓存内容，具体来讲，磁盘读写变成告诉缓存读写，用户向告诉缓存发出读写请求，如果用户请求数据在告诉缓存中，操作系统直接返回数据给用户；如果不在，才发出磁盘的请求去读写磁盘
- 哈希链表，要根据一个关键字（磁盘号）来快速查找是否在高速缓存中，在高速缓存中以磁盘块形成一个哈希表来组织已经载入的磁盘快数据
- 空闲链表，如果发现高速缓存中没有用户请求的磁盘块，此时应该去读写物理磁盘，这就要求在高速缓存中取出一个空闲的缓存块，用来缓存磁盘块中的读出的数据，而组织空闲块通常使用空闲链表

## 文件抽象
- 顺序存储，一个文件的内容存储到一个连续或者多个连续的磁盘块中，对于顺序存储结构，完成这个映射需要文件名，起始块号，文件长度用于表示一个文件（FCB，文件控制块），这种存储方案对于读数据高效，写数据非常费时
- 链式存储，文件字符流存放磁盘快不需要连续，只要每个磁盘块中存放下一个字符流片段所在的磁盘块号即可，这样就形成了磁盘块的链表，这种方案读数据效率低，文件修改效率高
- 索引结构存储，文件字符流被分割成多个逻辑块，在物理磁盘上寻找一些空闲的物理块，将这些物理块的的内容存放进去，然后在找一个磁盘块作为索引块，其中按序存放各个逻辑块对应的物理磁盘。这个是顺序存储和链式存储的折中。